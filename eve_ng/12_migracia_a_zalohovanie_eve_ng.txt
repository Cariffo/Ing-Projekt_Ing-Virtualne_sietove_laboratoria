************* ZOZNAM SUBOROV A ADRESAROV NA MIGRACIU *************

*************
DOLEZITE ADRESARE

  /opt/unetlab/addons
    -obrazy diskov (z adresára addons musíme vylúčiť podadresár "/opt/unetlab/addons/iol/lib", aby nedošlo ku konfliktu súborov!)

  /opt/unetlab/labs
    -projektové súbory (topológie)

  /opt/unetlab/html/templates
    -šablóny pre jednotlivé typy zariadení
    -TODO - lepsie by bolo, keby bol na to urceny skript v ramci aktualizacnej procedury

  /var/lib/mysql
    -adresar s mysql databazami
    -neda sa zalohovat kopirovanim adresara na iny pocitac - musime pouzit mysqldump

*************
DOLEZITE SUBORY

  /etc/hostname
    -ak chceme zmenit hostname servera, potrebujeme ho zmenit aj v:
      -/etc/apache2/apache2.conf
      -/etc/apache2/sites-enabled/unetlab.conf

  /etc/network/interfaces
    -kvoli statickej IPv4
    -vypnuta IPv6 (manual)

  /apache2/conf/apache2.conf
    -upravene podla suboru "06_zabezpecenie_servera.txt"
    -zmenene ServerName na sirena

  /etc/apache2/sites-enabled/unetlab.conf
    -pocuvanie na konkretnej IPcke: zmena z '<VirtualHost *:80>' na '<VirtualHost IP_ADRESA_SERVERA:80>'
    -presmerovanie HTTP (port 80) na HTTPS (port 443): pridany riadok 'Redirect / https://IP_ADRESA_SERVERA/' pod '<VirtualHost *:80>' resp. '<VirtualHost IP_ADRESA_SERVERA:80>'
    -zmenene ServerName na sirena

  /etc/apache2/sites-enabled/default-ssl.conf
    -zmena - pocuvanie na konkretnej IPcke '<VirtualHost _default_:443>' na '<VirtualHost IP_ADRESA_SERVERA:443>'
    -zmenene ServerName na sirena (ak je pritomne)

  /etc/issue.net -> SSH sprava pred prihlasenim
  /etc/motd -> SSH sprava po prihlaseni


************* POSTUP ZALOHOVANIA *************

*************
Skript na zalohovanie na vzdialeny server.

Pouzivam 'rsync' na zalohovanie najdolezitejsich adresarov suborov do LXC kontajnera. EVE-ng server sa voci LXC kontaineru autentifikuje SSH certifikatom, takze nemusime manualne zadavat heslo.


vim.tiny zaloha_na_eve_backup.sh


#!/bin/bash

# Pass PATH variable with path to this script for cron job
# Add script directory to the beginning of the PATH variable (in my case, the script is located in '/home/andrej/')
PATH=/home/andrej:/home/andrej/bin:/home/andrej/.local/bin:/home/andrej/bin:/home/andrej/.local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games

EVE_BACKUP_IP=<IP_adresa_zalohovacieho_servera>
HOME_DIR=/home/andrej

rsync -a -e "ssh -i $HOME_DIR/.ssh/id_rsa" \
  --rsync-path="mkdir -p /home/andrej/eve-ng_zaloha/opt_unetlab_addons_dynamips && rsync" \
  /opt/unetlab/addons/dynamips/ \
  andrej@$EVE_BACKUP_IP:/home/andrej/eve-ng_zaloha/opt_unetlab_addons_dynamips

rsync -a -e "ssh -i $HOME_DIR/.ssh/id_rsa" \
  --rsync-path="mkdir -p /home/andrej/eve-ng_zaloha/opt_unetlab_addons_iol_bin && rsync" \
  /opt/unetlab/addons/iol/bin/ \
  andrej@$EVE_BACKUP_IP:/home/andrej/eve-ng_zaloha/opt_unetlab_addons_iol_bin

rsync -a -e "ssh -i $HOME_DIR/.ssh/id_rsa" \
  --rsync-path="mkdir -p /home/andrej/eve-ng_zaloha/opt_unetlab_addons_qemu && rsync" \
  /opt/unetlab/addons/qemu/ \
  andrej@$EVE_BACKUP_IP:/home/andrej/eve-ng_zaloha/opt_unetlab_addons_qemu

rsync -a -e "ssh -i $HOME_DIR/.ssh/id_rsa" \
  --rsync-path="mkdir -p /home/andrej/eve-ng_zaloha/opt_unetlab_addons_rozne_zariadenia && rsync" \
  /opt/unetlab/addons/rozne_zariadenia/ \
  andrej@$EVE_BACKUP_IP:/home/andrej/eve-ng_zaloha/opt_unetlab_addons_rozne_zariadenia

rsync -a -e "ssh -i $HOME_DIR/.ssh/id_rsa" \
  --rsync-path="mkdir -p /home/andrej/eve-ng_zaloha/opt_unetlab_addons && rsync" \
  /opt/unetlab/addons/rozne_zariadenia_prehlad.txt \
  andrej@$EVE_BACKUP_IP:/home/andrej/eve-ng_zaloha/opt_unetlab_addons/
rsync -a -e "ssh -i $HOME_DIR/.ssh/id_rsa" \
  /opt/unetlab/addons/rozne_zariadenia_subory.txt \
  andrej@$EVE_BACKUP_IP:/home/andrej/eve-ng_zaloha/opt_unetlab_addons/

rsync -a -e "ssh -i $HOME_DIR/.ssh/id_rsa" \
  --rsync-path="mkdir -p /home/andrej/eve-ng_zaloha/opt_unetlab_labs && rsync" \
  /opt/unetlab/labs/ \
  andrej@$EVE_BACKUP_IP:/home/andrej/eve-ng_zaloha/opt_unetlab_labs

mysqldump -u root --password='<pouzivatelske_heslo>' eve_ng_db > $HOME_DIR/eve_ng_db.sql 2>&1
mysqldump -u root --password='<pouzivatelske_heslo>' guacdb > $HOME_DIR/guacdb.sql 2>&1
mysqldump -u root --password='<pouzivatelske_heslo>' --all-databases > $HOME_DIR/vsetky_mysql_databazy.sql 2>&1

rsync -a -e "ssh -i $HOME_DIR/.ssh/id_rsa" \
  --rsync-path="mkdir -p /home/andrej/eve-ng_zaloha/var_lib_mysql && rsync" \
  $HOME_DIR/eve_ng_db.sql \
  andrej@$EVE_BACKUP_IP:/home/andrej/eve-ng_zaloha/var_lib_mysql
rsync -a -e "ssh -i $HOME_DIR/.ssh/id_rsa" \
  $HOME_DIR/guacdb.sql \
  andrej@$EVE_BACKUP_IP:/home/andrej/eve-ng_zaloha/var_lib_mysql
rsync -a -e "ssh -i $HOME_DIR/.ssh/id_rsa" \
  $HOME_DIR/vsetky_mysql_databazy.sql \
  andrej@$EVE_BACKUP_IP:/home/andrej/eve-ng_zaloha/var_lib_mysql

rm $HOME_DIR/eve_ng_db.sql
rm $HOME_DIR/guacdb.sql
rm $HOME_DIR/vsetky_mysql_databazy.sql


*************
Periodicke vykonavanie zalohovacieho skriptu

-Tento zalohovaci skript sa bude vykonavat periodicky: kazdy den o 3:00.
Preto vytvorime cron job, ktory sa bude starat o periodicke vykonavanie tohto skriptu.
(ako textovy EDITOR mozeme pouzit napr. 'vim.tiny')

  EDITOR=vim.tiny crontab -e


-Ak je toto prva cron uloha, najprv sa presvedcime, ci sa cron ulohy vobec vykonavaju. na koniec suboru pridame riadok:

  * * * * * /home/andrej/zaloha_na_eve_backup.sh >/dev/null 2>&1

-tato uloha sa bude vykonavat kazdu minutu.
-ulozime
-restartujeme cron sluzbu, aby sa zmeny prejavili

  sudo service cron restart

-Zoznam cron uloh (pre nas pouzivatelsky ucet) zobrazime prikazom:

  crontab -l

Uvidime obsah crontab suboru s ulohami.

-Stav vykonavania uloh zobrazime prikazom:

  sudo service cron status

Uvidime, ako kazdu minutu cron spusta nas skript.

Ked sme sa presvedcili, ze nas skript sa vykonava kazdu minutu, zakomentujeme ho a nahradime ho finalnou verziou:

  0 3 * * * /home/andrej/zaloha_na_eve_backup.sh >/dev/null 2>&1

-tento skript sa bude vykonavat kazdu nultu minutu, kazdu tretiu hodinu, kazdy v tyzdni, vsetky mesiace, a lubovolny den v tyzdni
-ulozime
-skontrolujeme crontab, ci sa uloha zmenila:

  crontab -l

-restartujeme cron sluzbu, aby sa zmeny prejavili

  sudo service cron restart

*************
Skript na lokalne zalohovanie.

Ale najlepsie by bolo, keby sa hlavny disk zalohoval klonovanim na dalsie lokalne disky na serveri aj vzdialene, aby sme sa nemuseli spoliehat na lokalny system. Zalohovanie sa bude vykonavat kazdy den, najlepsie v noci.


dd bootsektor
rsync /




************* POSTUP OBNOVY *************

-Obsah adresárov na zálohovacom serveri skopírujeme do príslušných adresárov na primárnom serveri. To, kam dáta v danom adresári na zálohovacom serveri patria, hovorí názov daného adresára.
-Pomenovanie adresárov na zálohovacom serveri je odvodený od absolútnej cesty zálohovaných súborov s tým, že namiesto lomítok '/' som použil podčiarknik '_' (úvodné lomítko som vynechal).
Napr. keď boli súbory zálohované z primárneho servera z cesty '/opt/unetlab/addons', potom súbory, ktoré sa z tohto adresára zálohujú budú patriť do adresára 'opt_unetlab_addons' (úvodné lomítko vynechané, zvyšné lomítka nahradené podčiarknikom). Na rovnakú cestu ich aj obnovíme.

-Obsah adresára '/var/lib/mysql' nekopírujeme priamo do rovnakého adresára na primárnom serveri. Namiesto toho pouzijeme príkaz:

  mysql -u root -ptecmint rsyslog < rsyslog.sql
napr.
  mysql -u root --password='<pouzivatelske_heslo>' eve_ng_db < /home/andrej/eve_ng_db.sql

Takto obnovíme všetky zálohované databázy.

-Pokiaľ obnovujeme databázu, ktorá už existuje, použijeme príkaz:

  mysqlimport -u root -ptecmint rsyslog < rsyslog.sql
napr.
  mysqlimport -u root --password='<pouzivatelske_heslo>' eve_ng_db < /home/andrej/eve_ng_db.sql



Zdroje:

https://stackoverflow.com/questions/818255/in-the-shell-what-does-21-mean

-RSYNC
http://superuser.com/questions/387477/sftp-upload-all-files-directories-and-sub-directories-contained-in-a-folder#387543
http://www.eve-ng.net/index.php/faq
https://unix.stackexchange.com/questions/127352/specify-identity-file-id-rsa-with-rsync
https://www.liquidweb.com/kb/using-rsync-to-transfer-and-synchronize-local-and-remote-systems/
https://www.tecmint.com/mysql-backup-and-restore-commands-for-database-administration/
https://stackoverflow.com/questions/1636889/rsync-how-can-i-configure-it-to-create-target-directory-on-server
http://www.schwertly.com/2013/07/forcing-rsync-to-create-a-remote-path-using-rsync-path/

-CRON
https://crontab-generator.org/
https://askubuntu.com/questions/23009/why-crontab-scripts-are-not-working
http://www.ubuntututorials.com/use-crontab-ubuntu/
https://askubuntu.com/questions/222512/cron-info-no-mta-installed-discarding-output-error-in-the-syslog
https://www.cyberciti.biz/faq/howto-linux-unix-start-restart-cron/