Nástroj EVE-ng môžeme nainštalovať buď z ISO súboru dostupného na stiahnutie zo stránky "http://www.eve-ng.net/index.php/community" alebo nainštalujeme operačný systém "Ubuntu Server", do ktorého neskôr pridáme nástroj EVE-ng. Nižšie opisujem kroky pred a počas inštalácie EVE-ng servera. Operačný systém "Ubuntu Server" inštalujem vo verzii 16.04, pretože ten je oficiálne podporovaný pre nástroj EVE-ng vo verzii v2.0.3-86.



************* PRED INŠTALÁCIOU NA FYZICKÝ SERVER *************

Snažil som sa minimalizovať komplikácie, ku ktorým by mohlo dôjsť pri inštalácii EVE-ng servera. Preto som vyčistil server od prachu, otestoval som všetky disky na chybné sektory, rozpustil RAID zväzok, nastavil BIOS, vytvoril inštalačné USB médium s operačným systémom "Ubuntu Server x64 16.04" a nainštaloval spomínaný operačný systém z USB média na server.


*************
Vyčistenie servera

Stlačeným vzduchom prefúkneme ventilátory a tesné priestory od prachu.


*************
Test disku na chybné sektory

Pred inštaláciou na fyzicky server otestujeme disk na chybné sektory. Tak predídeme chybám, ktoré môžu vzniknúť až po inštalácii.

Najprv vytvoríme tzv. "live" USB disk s ľubovoľnou Linux distribúciou, napr. s "Ubuntu Desktop". ISO súbor spomenutého operačného systému je dostupné na stránke "https://www.ubuntu.com/download/desktop".

Po stiahnutí ISO súboru vytvoríme inštalačný USB disk. V Linux distribúciách môžeme použiť príkaz "dd" alebo nástroj "Etcher", čo je odporúčaná a bezpečnejšia voľba pre vytváranie spustiteľného USB disku. V operačnom systéme Windows môžeme použiť napr. nástroje "Rufus" alebo "Linux Live USB Creator (LiLi)".

Môžeme si vybrať ľubovoľný z vyššie uvedených nástrojov. avšak postup pri vytváraní "live" USB disku pre každý zo spomenutý nástroj nie je predmetom tejto práce.

Akonáhle sme "live" USB disk vytvorili, pripojíme ho ku serveru. Následne pripojený USB disk zvolíme na spustenie; buď v nástroji BIOS alebo v tzv. "Boot Menu".

Po spustení operačného systému z USB disku otvoríme terminál a zadáme príkaz

  sudo -i
  lsblk

Zobrazí sa zoznam pripojených diskov. Disk s názvom "/dev/sda" je obvykle USB disk, z ktorého sme systém spustili. Zistíme názvy pripojených pevných diskov napr. /dev/sdb".

Potom, ako sme zistili názov disku, ktorý chceme skontrolovať, vyhľadáme chybné bloky na disku príkazom

  badblocks -v /dev/sdb > badsectors_sdb.txt

Operácia môže trvať dlhší čast; na 320GB HDD to trvalo približne jednu hodinu. V prípade, že sa nájdu chybné sektory na disku, zapíšu sa do súboru "badsectors_sdb.txt".

Po dokončení kontroly sa zobrazí výsledok

  0 bad blocks

Skontrolujeme obsah súboru "badsectors_sdb.txt"

  cat badsectors_sdb.txt

Ak je súbor prazdny, disk je v poriadku a môžeme ho použiť. V opačnom prípade si uložíme textový súbor na iné miesto napr. na iný USB/HDD disk, email, cloud a pod. Tento súbor obsahuje zoznam poškodených sektorov pevného disku. Súbor potom slúži ďalším nástrojom na to, aby sa vyhýbali týmto sektorom pri práci s diskom.

Príkazmi "e2fsck" alebo "fsck" vieme zabezpečiť, že sa zabráni operačnému systému používať chybné sektory na zvolenom pevnom disku.

Príkaz pre súborové systémy ext2/ext3/ext4:

  sudo e2fsck -l badsectors.txt /dev/sda10

Príkaz pre ostatné súborové systémy:

  sudo fsck -l badsectors.txt /dev/sda10


*************
Nastavenie BIOS

V nástroji BIOS som upravil nastavenia tak, aby bol zaistený plynulý chod servera.

Bola aktivovaná funkcia "Asus Smart Fan II", aby server nemusel mať ventilátory stále na plný výkon, čím sa predlžuje ich životnosť.

Funkcia "Restore on AC loss" bola nastavená na "Power On", aby sa server znovu zapol pri výpadku elektriny.

V "Boot Priority Options" bolo nastavené spúšťanie iba z jediného pevného disku. Ostatné disky budú slúžiť ako záložné alebo podporné disky. Najprv odstránime všetky zariadenia z "Boot Priority Options", uložíme nastavenia (F10 -> odpovedať "Yes" na otázku, či chceme uložiť nastavenia). Malo by sa objaviť hlásenie, že nenašiel spustiteľné zariadenie. Potom reštartujeme znovu (klávesová skratka "Ctrl + Alt + Del"), vôjdeme do nástroja BIOS, pridáme jedno zariadenie do zoznamu v "Boot Priority Options" a reštartujeme. Keď sa server spustí, vybrali sme ten správny disk s operačným systémom. Inak znovu vôjdeme do nástroja BIOS, odstránime aktuálne zariadenie v "Boot Priority Options" a vyberieme ďalšie, kým nenájdeme ten správny disk a server sa nespustí.

Môžeme ešte nastaviť heslo do nástroja BIOS. Tento krok som vynechal, keďže pri zabudnutí tohto hesla by bolo jeho prelomenie resp. odstránenie náročné.


*************
Upgrade nástroja BIOS
-ak je mozne, aktualizujeme BIOS na najnovsiu verziu.
V mojom prípade to mozne nebolo, pretoze by to vyzadovalo vytvorenie diskety s aktualizacnymi subormi. A jedina disketova mechanika je v tom serveri.

Postup vytvorenia aktualizacnej diskety
-stiahneme si Rufus
-nastavime ho
  -Device: zvolime si disk
  -Partition scheme and target system type: MBR partition scheme for BIOS or UEFI computers
  -File System: FAT alebo FAT32
  -Cluster size: default
  -New volume label: odstránime vsetko (prazdny)
  -Quick Format: zaskrtnute
  -Create a bootable disk using: MS-DOS
  -Create extenden label and icon files: odskrtnute
-Start

Vytvorene USBcko pripojime ku serveru a zapneme ho.
Vojdeme do nástroja BIOS a zmenime prioritu spúšťania tak, aby bolo USB na prvom mieste.
V BIOSe ešte nastavime "Flash Write" na Disabled, aby sme vypli ochranu nástroja BIOS proti zapisu a mohli BIOS aktualizovat.
Stlacime F10 (Ulozime nastavenia) -> Yes

Server sa restartuje.
Po chvili sa objavi MS-DOS s obrazovkov vyberu rozlozenia klavesnice. Odporucam vybrat "English-US".
Ale po spusteni aktualizacneho skriptu sa objavi chybova hlaska "Cannot flash if Memory Managers (e.g. HIMEM) present"
Tak som zase v BIOSe nastavil "Flash Write" na Enabled (zapnutie ochrany nástroja BIOS pred prepisanim), vybral som USBcko a restartoval server.

Ukazalo sa, že aktualizacia nástroja BIOS na serveri je technicky narocna, preto som sa rozhodol nevykonat ju.


************* ************* ************* ************* *************

TESNE PRED INŠTALÁCIOU ODPOJÍME VŠETKY DISKY OKREM DISKU, NA KTORÝ
CHCEME EVE-NG/UBUNTU NAINŠTALOVAŤ! ZJEDNODUŠÍME TAK INŠTALAČNÝ PROCES
A PREDÍDEME CHYBÁM PRI PARTÍCIOVANÍ A NÁHODNEJ STRATE DÁT Z INÝCH DISKOV.

************* ************* ************* ************* *************

************* POSTUP INSTALACIE *************

VYTVORENIE SPUSTITEĽNÉHO USB S UBUNTU SERVER

  -Vytvoriť spustiteľné USB z Ubuntu Server 16.04 ISO súboru je istejšie,
   než z EVE ISO, pretože to s EVE sa nemusí spustiť. Aj Etcher napíše, 
   že ISO súbor nie je spustiteľný ("not bootable").
  
USB médium vytvoríme podľa návodu uvedeného v časti "Testovanie diskov na chybné sektory".



-Spustime prave nakonfigurovanu EVE virtualku
 resp.
 Spustíme/reštartujeme server a pri BOOT obrazovke opakovane stláčame klávesu
 (v mojom prípade klávesu F8) vyberieme USB zariadenie. Spustí sa inštalačná
 procedúra

-Vyberieme Anglicky jazyk (pre jednoduchsi troubleshooting)

-Zvolime moznost Install Ubuntu Server (prvá možnosť)
 resp.
 "Install EVE Bare" pri inštalácií z EVE ISO

-Zvolíme krajinu (other->Europe->Slovakia).
-Rozloženie klávesnice (en_US.UTF-8)
-Preskočíme automatickú detekciu rozloženia podľa klávesnice
  -zvolíme "No"
  -nastavíme rozloženie klávesnice na "[English (US)]"
-Zvolíme "[English (US)]"
-V prípade, že máme viac siťových kariet, sme vyzvaní vybrať si
 tú, ktorá bude pripojená na internet
-"Nameserver adresses" môžeme preskočiť -> Continue (Enter)
-Nastavíme ľubovoľný hostname
-Zadáme celé meno používateľa
-Zadáme názov používateľského účtu
-Zopakujeme heslo pre používateľa
-"Encrypt home directory"
 vyberieme voľbu "No" - jednoduchšie zálohovanie

-PARTÍCIOVANIE

MOŽNOSŤ 1:
Pri partíciovaní odporúčam z vlastnej skúsenosti 
 zvoliť "Guided – use entire disk" - vyhradíme celý disk pre Ubuntu.
 
 Táto možnosť ale vyhradí príliš veľké miesto pre swap partíciu.
 
 Preto na obrazovke "Write changes" sa navigujeme na swap partíciu,
 zvolíme ju klávesou Enter a zvolíme "Delete partition".
 Následne primárnu ext4 partíciu rozšírime -> zvolíme ju a zvolíme možnosť
 "Resize partition" -> zadáme (väčší) rozmer partície a potvrdíme.

 Ak je potrebné, vyberieme primárnej ext4 partícií prípojný bod (mount 
 point) "/".

 Nakoniec potvrdíme zmeny -> "Write changes to disk"

MOŽNOSŤ 2:
-podľa EVE-ng dokumentácie
-potvrdíme všetky predvolené hodnoty

> Partition disks: Guided - use entire disk and setup LVM
> Partition disks: Choose your main HDD were ubuntu will be installed.
  Usually it will be single HDD, if your raid is set right.

> Write changes to disk and create LVM: YES
> Amount of volume: leave all offered size
> Force UEFI Installation: YES (na starších serveroch zvolíme "No")
> Write changes to disk: YES


-Nastavíme proxy (ak nemáme žiaden proxy server, necháme prázdne).

-Pri dotaze na automatické aktualizácie zvolíme "No automatic updates", 
 aby sme predišli nepredvídaným následkom. Aktualizácia servera bude na 
 vyžiadanie (on demand) a je za ňu zodpovedný administrátor.

Ak sme aj napriek tomu zvolili automaticke aktualizacie, vieme ich vypnut:

  sudo vim.tiny /etc/apt/apt.conf.d/20auto-upgrades

zmenime

APT::Periodic::Update-Package-Lists "1";
APT::Periodic::Unattended-Upgrade "1";

na

APT::Periodic::Update-Package-Lists "0";
APT::Periodic::Unattended-Upgrade "0";

!!
Aktualizácia EVE-ng si vyžaduje dodržanie presného postupu, 
ktorý je opísaný v súbore "aktualizovanie_eve_ng.txt"
!!

-Pridáme balíček "OpenSSH server" (ak sme vyzvaní).
-Nainštalujeme GRUB na disk. Ak sme vopred odpojili všetky pevné disky
 okrem jediného alebo sme vytvorili RAID zväzok, bude to jediná položka
 v zozname spolu s USB kľúčom.
-Po nainštalovaní GRUB zavádzača potvrdíme reštart voľbou "Continue".
 Server sa následne reštartuje.
 Ak sa po reštarte nespustí, vypneme ho dlhším podržaním napájacieho tlačidla.
 Následne ho znovu zapneme.

-Po reštarte sa prihlásime s predvolenymi prihlasovacimi udajmi "root/eve".
 Po prvom prihlasenie treba vykonat prvotnu konfiguraciu, ktora je opisana
 v subore "prvotna_konfiguracia_EVE_ng.txt".


*************
Rozpustenie RAID zväzku

Najprv som nainštaloval nástroj "EVE-ng" na server, keď boli disky ešte v RAID zväzku. Keď už bol server spustený, približne do hodiny začal na lokálnu konzolu vypisovať chybové hlásenia ohľadom diskov. Nič sa ale nevypisovalo do SSH konzoly.

Preto som rozpustil RAID zväzok, vybral som všetky disky, zvolil som si prvý disk, vložil som ho naspäť, aby bol zapojený iba jeden jediný disk, a otestoval som ho na chybné sektory. Kontrola ukázala, že disk bol v poriadku, preto som ho znovu preinštaloval do pôvodného stavu.

Po tejto zmene sa ani po niekoľkých hodinách sa neobjavilo žiadne chybové hlásenie ani na lokálnej, ani na SSH konzole. Neskôr som zapojil a otestoval aj zvyšné tri disky na serveri. Všetky boli v poriadku ("0 bad blocks").

Z toho vyplýva, že chyby s diskami na serveri spôsoboval s veľkou pravdepodobnosťou hardvérový RAID radič.


Zdroje:
https://blogs.technet.microsoft.com/csstwplatform/2012/06/25/how-to-create-a-ms-dos-bootable-usb-flash-drive/
https://www.computing.net/answers/windows-xp/phoenix-bios-upgrade-himem-message/192069.html#1
https://www.garron.me/en/linux/turn-off-stop-ubuntu-automatic-update.html
https://askubuntu.com/a/172527